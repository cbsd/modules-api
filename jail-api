#!/usr/local/bin/cbsd
#v13.0.1
DIST_MODULE_PATH="${distmoduledir}/api.d"
MYOPTARG="imgsize jname img ram cpus pubkey host_hostname ver"
MYARG="mode"
MYDESC="Operate with jail via API"
CBSDMODULE="sys"
ADDHELP="\
"
EXTHELP="wf_bhyve"
MODULE_PATH="${dbdir}/bhyve"

. ${subr}
ip4_addr=
. ${cbsdinit}
. ${system}
. ${strings}

readconf api.conf
readconf jail-api.conf

[ -z "${ver}" ] && ver="native"

set -e
. ${distmoduledir}/api.d/api.subr
set +e
MY_LOG="${cbsd_api_logdir}/jail-api.log"
log "wakeup: $*"

create_env()
{
	local ssh_user="root"		# always root for jail
	local ssh_port=
	local ssh_host=

	[ -z "${ssh_host}" ] && ssh_host="${nodeip}"
	[ -z "${ssh_user}" ] && err 1 "ssh_user empty? check img/mapping in bhyve-api.conf for: ${img}"

	ip4_addr=$( dhcpd ip4pool=${ip4pool} )

	# additional check for profile/type?

	cid=$( ${MD5_CMD} -qs "${pubkey}" )
	[ ! -d ${cbsd_api_dbdir}/${cid} ] && ${MKDIR_CMD} -p ${cbsd_api_dbdir}/${cid}
	[ ! -d ${cbsd_api_dbdir}/${cid}/.ssh ] && ${MKDIR_CMD} -p ${cbsd_api_dbdir}/${cid}/.ssh
	if [ ! -r ${cbsd_api_dbdir}/${cid}/.ssh/authorized_keys ]; then
		echo "${pubkey}" > ${cbsd_api_dbdir}/${cid}/.ssh/authorized_keys
		sync
		#fflush?
		sleep 1
	fi
	[ ! -d ${cbsd_api_dbdir}/${cid}/vms ] && ${MKDIR_CMD} -p ${cbsd_api_dbdir}/${cid}/vms

	str="cbsd jcreate \
		jname=${jname} \
		host_hostname=\"${host_hostname}\" \
		runasap=1 \
		ip4_addr=\"${ip4_addr}\" \
		ver=\"${ver}\" \
		fsquota=\"${imgsize}\" \
		ci_user_pubkey=\"${cbsd_api_dbdir}/${cid}/.ssh/authorized_keys\" \
		pkg_bootstrap=0 \
		"

	log "exec [${str}]"
	${str}

	if [ "${nodeip_expose}" = "0" ]; then
		port=22
		ssh_host="${ip4_addr}"
	else
		jname_id=$( echo ${jname} | ${TR_CMD} -d 'env' )
		port=$(( jname_id + 4000 ))
		log "expose mode=add jname=${jname} in=${port} out=22"
		expose mode=add jname=${jname} in=${port} out=22
	fi

	echo $( hostname ) > ${cbsd_api_dbdir}/${cid}/${jname}.node
	echo "${host_hostname} (jail) ssh ${ssh_user}@${ssh_host} -p${port}" > ${cbsd_api_dbdir}/${cid}/vms/${jname}
	echo -n "ssh ${ssh_user}@${ssh_host} -p${port}" > ${cbsd_api_dbdir}/${cid}/${jname}-bhyve.ssh
}

## MAIN
case "${mode}" in
	create)
		create_env
		;;
esac

exit 0
